<html>
<meta http-equiv="Cache-Control" content="no-store" />
<head>
  <title>BoardGameGeek collection web data connector</title>
  <script src="http://ajax.googleapis.com/ajax/libs/jquery/1.11.1/jquery.min.js" type="text/javascript"></script>
  <script src="https://connectors.tableau.com/libs/tableauwdc-1.1.1.js" type="text/javascript"></script>
  <script type="text/javascript">
  (function() {
      var myConnector = tableau.makeConnector();

	myConnector.getColumnHeaders = function() {
		var fieldNames = ['BoardgameName'];
		var fieldTypes = ['string'];
		tableau.headersCallback(fieldNames, fieldTypes);
	}

      myConnector.getTableData = function(lastRecordToken) {
		var dataToReturn = [];
		var hasMoreData = false;

		// Get parameter values and build query query
		var bggUsername = tableau.connectionData;
		
		//var connectionUri = buildUri(ticker, startDate, endDate);
		//connectionUri = 'http://boardgamegeek.com/xmlapi2/collection?username=' + bggUsername
		connectionUri = 'http://bgg-api.herokuapp.com/api/v1/collection?username=' + bggUsername
		
		var xhr = $.ajax({
		  url: connectionUri,
		  dataType: 'json',
		  success: function (data) {
			console.log("in good section");
			  if (data.query.results) {
				  var games = data.query.results.quote;
				  var ii;
				  for (ii = 0; ii < games.length; ++ii) {
					  var entry = {'BoardgameName': games[ii].name
					  dataToReturn.push(entry);
								 };
				  }
				  tableau.dataCallback(dataToReturn, lastRecordToken, false);
				}
				else {
				  tableau.abortWithError("No results found for username: " + bggUsername);
				}
		  },
		  error: function (xhr, ajaxOptions, thrownError) {

		  
			  // If the connection fails, log the error and return an empty set.
			  tableau.log("in bad section: Connection error: " + xhr.responseText + "\n" + thrownError);
			  tableau.abortWithError("Error while trying to connect to the BoardGameGeek data source.");
		  }
		});
	}
	  
	  
	  tableau.registerConnector(myConnector);
  	    
  })();
  
  
  $(document).ready(function() {
		$("#submitButton").click(function() {
		var bggUsername = $('#bggUsername').val().trim();
		if (bggUsername) {
			tableau.connectionName = "BoardGameGeek collection data for user" + bggUsername;
			tableau.connectionData = bggUsername;
			tableau.submit();
		}
		});
	});
  
  
  </script>
</head>
<body>

 <p>Enter the username of the BoardGameGeek user: <input type="text" id="bggUsername" /></p>
  <p><button type="button" id="submitButton">Get the data</button></p>

</body>
</html>